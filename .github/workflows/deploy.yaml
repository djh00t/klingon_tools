name: "ðŸš€ Deploy to TestPyPI and PyPI"

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4.1.7
    - name: Set up Python
      uses: actions/setup-python@v5.1.0
      with:
        python-version: 3.x
    - name: Install dependencies
      run: 'python -m pip install --upgrade pip

        pip install -r requirements.txt

        '
    - name: Install test dependencies
      run: 'pip install pytest

        '
    - id: version
      name: Increment version
      run: "export VERSION=$(cat VERSION)\nexport NEW_VERSION=$(echo $VERSION | awk\
        \ -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')\nPYPI_VERSION=$(curl -s https://pypi.org/pypi/klingon_tools/json\
        \ | jq -r .info.version)\nTEST_PYPI_VERSION=$(curl -s https://test.pypi.org/pypi/klingon_tools/json\
        \ | jq -r .info.version)\nHIGHEST_VERSION=$(echo -e \"$NEW_VERSION\\n$PYPI_VERSION\\\
        n$TEST_PYPI_VERSION\" | sort -V | tail -n 1)\nif [ \"$HIGHEST_VERSION\" !=\
        \ \"$NEW_VERSION\" ]; then\n  NEW_VERSION=$(echo $HIGHEST_VERSION | awk -F.\
        \ '{print $1\".\"$2\".\"$3+1}')\nfi\necho $NEW_VERSION > VERSION\nsed -i \"\
        s/version=\\\"[0-9]*\\.[0-9]*\\.[0-9]*\\\"/version=\\\"$NEW_VERSION\\\"/\"\
        \ setup.py\ngit add VERSION setup.py\ngit commit -m \"Bump version to $NEW_VERSION\"\
        \ngit push origin main\necho \"::set-output name=new_version::$NEW_VERSION\"\
        \n"
    - id: create_pr
      name: Create and Merge Version Update PR
      uses: peter-evans/create-pull-request@v6.1.0
      with:
        body: This PR bumps the version to ${{ steps.version.outputs.new_version }}.
        branch: update-version-${{ steps.version.outputs.new_version }}
        commit-message: 'chore: bump version to ${{ steps.version.outputs.new_version
          }}'
        merge-commit-body: This PR was automatically created by GitHub Actions.
        merge-commit-message: 'chore: bump version to ${{ steps.version.outputs.new_version
          }}'
        merge-commit-title: Version bump to ${{ steps.version.outputs.new_version
          }}
        merge-method: squash
        title: 'chore: bump version to ${{ steps.version.outputs.new_version }}'
        token: ${{ secrets.GITHUB_TOKEN }}
    - name: Build and Test
      run: 'python setup.py sdist bdist_wheel

        pip install .

        make test

        '
    - name: Deploy to TestPyPI
      run: 'twine upload --repository-url https://test.pypi.org/legacy/ dist/* -u
        ${{ secrets.TEST_PYPI_USER_AGENT }}

        '
    - name: Test from TestPyPI
      run: 'pip install --index-url https://test.pypi.org/simple/ --extra-index-url
        https://pypi.org/simple my-package

        '
    - name: Deploy to PyPI
      run: 'twine upload dist/* -u ${{ secrets.PYPI_USER_AGENT }}

        '
